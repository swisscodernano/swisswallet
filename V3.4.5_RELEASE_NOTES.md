# SwissWallet v3.4.5 - Swiss Tor Timeout Fix

**Release Date**: 2025-10-11
**Build Status**: In Progress
**Primary Fix**: HTTP timeout issues with Tor onion service coordinator

---

## üéØ What This Release Fixes

**Problem**: Wallet shows "Awaiting coinjoin" but never starts - times out after ~10 minutes trying to communicate with Swiss coordinator over Tor.

**Root Cause Identified**: Two layers of HTTP timeouts were too short for Tor onion services:
1. HttpClient default timeout: 100 seconds (too short)
2. RoundStateUpdater internal timeout: **30 seconds (critical bottleneck)**

**Solution**: Dramatically increased timeouts and added detailed diagnostic logging.

---

## üìù Changes in v3.4.5

### 1. **Increased RoundStateUpdater Timeout** (`RoundStateUpdater.cs:100-128`)

**Before**:
```csharp
using CancellationTokenSource timeoutCts = new(TimeSpan.FromSeconds(30));  // Too short!
```

**After**:
```csharp
//  SwissWallet: Increased timeout for Tor onion services
// Original 30s timeout was too short for slow Tor circuits
// Increased to 180s (3 minutes) to accommodate onion service latency
using CancellationTokenSource timeoutCts = new(TimeSpan.FromSeconds(180));
```

**Impact**: This was the PRIMARY bottleneck. 30 seconds was far too short for:
- Tor circuit establishment
- Onion service rendezvous
- Multi-hop routing latency
- Coordinator processing time

### 2. **Increased HttpClient Timeout** (`SwissCoordinatorHttpClientFactory.cs:53-60`)

**Added**:
```csharp
// SwissWallet: Increased timeout for Tor onion services
// Onion services can be slow due to circuit establishment and rendezvous
// Default 100s is too short, increasing to 300s (5 minutes)
httpClient.Timeout = _currentCoordinator.Type == CoordinatorType.OnionService
    ? TimeSpan.FromSeconds(300) // 5 minutes for onion services
    : TimeSpan.FromSeconds(120); // 2 minutes for clearnet

Logger.LogDebug($"üá®üá≠ HTTP client timeout set to {httpClient.Timeout.TotalSeconds}s for {_currentCoordinator.Type}");
```

**Impact**: Ensures HTTP layer doesn't cancel requests before internal timeout.

### 3. **Added Detailed Timing Diagnostics** (`RoundStateUpdater.cs:106-127`)

**New Logging**:
```csharp
Logger.LogDebug($"üåê Requesting round state from coordinator (timeout: 180s)...");

// On success:
Logger.LogDebug($"‚úÖ Round state received in {elapsed.TotalSeconds:F1}s ({response.RoundStates.Length} rounds)");

// On timeout:
Logger.LogWarning($"‚è±Ô∏è Round state request timeout after {elapsed.TotalSeconds:F1}s - coordinator not responding");

// On other errors:
Logger.LogWarning($"‚ùå Round state request failed after {elapsed.TotalSeconds:F1}s: {ex.Message}");
```

**Impact**: User logs will now show:
- Exact timing of each coordinator request
- Whether timeouts are still occurring (and how long they took)
- Number of rounds received from coordinator
- Clear distinction between timeout vs other errors

### 4. **Code Refactoring for Maintainability** (`RoundStateUpdater.cs:130-155`)

Split `UpdateRoundsStateAsync` into two methods:
- `UpdateRoundsStateAsync`: Handles HTTP request, timing, and error logging
- `ProcessRoundStates`: Processes the received round data

**Impact**: Cleaner code, easier to maintain, better separation of concerns.

---

## üìä Expected Behavior After v3.4.5

### What You'll See in Logs:

**Scenario A - Success (Coordinator Responding)**:
```
[DEBUG] üåê Requesting round state from coordinator (timeout: 180s)...
[DEBUG] ‚úÖ Round state received in 45.3s (2 rounds)
[INFO] ‚úÖ Found suitable round abc123... in phase InputRegistration
[INFO] CoinJoin starting...
```

**Scenario B - Timeout (Coordinator Not Responding)**:
```
[DEBUG] üåê Requesting round state from coordinator (timeout: 180s)...
[WARNING] ‚è±Ô∏è Round state request timeout after 180.1s - coordinator not responding
[INFO] CoinJoinClient was cancelled
[INFO] CoinJoinClient restart automatically
```

**Scenario C - No Suitable Rounds**:
```
[DEBUG] üåê Requesting round state from coordinator (timeout: 180s)...
[DEBUG] ‚úÖ Round state received in 8.2s (0 rounds)
[INFO] ‚è±Ô∏è Timeout: No suitable CoinJoin round found after 10 minutes
[INFO] CoinJoinClient restart automatically
```

---

## üß™ Testing Instructions

### 1. Install v3.4.5

Download from: https://github.com/swisscodernano/swisswallet/releases/tag/v3.4.5

**macOS ARM64 (M1/M2/M3)**:
```bash
wget https://github.com/swisscodernano/swisswallet/releases/download/v3.4.5/SwissWallet-3.4.5-macOS-arm64.zip
unzip SwissWallet-3.4.5-macOS-arm64.zip
# Follow macOS Gatekeeper workaround in MACOS_SIGNING.md if needed
```

### 2. Verify Version

Open SwissWallet ‚Üí Check version shows:
- **Version**: 3.4.5
- **Name**: "Swiss Tor Timeout Fix"

### 3. Run Test

1. Open BitDen3 wallet (or any wallet with coins eligible for mixing)
2. Ensure AutoCoinJoin is enabled (Wallet Settings ‚Üí Privacy)
3. Wait **minimum 3-4 minutes** (new timeout is 3 minutes)
4. Check logs at: `~/.swisswallet/client/Logs.txt`

### 4. Share Logs

Copy the relevant section from logs showing:
- üåê Round state requests
- ‚úÖ Success messages OR ‚è±Ô∏è timeout messages
- Timing information (e.g., "received in X.Xs")

---

## üîç What to Look For

### Good Signs ‚úÖ:
- Logs show round state received in < 180s
- "Found suitable round" messages appear
- CoinJoin proceeds normally

### Bad Signs ‚ùå:
- "timeout after 180.1s" messages (coordinator not responding)
- Repeated 180s timeouts (coordinator issue, not wallet issue)
- No rounds received from coordinator (0 rounds)

### Important Note:

If you see timeouts even with 180s limit, the issue is **NOT the wallet** - it's the coordinator:
- Coordinator may be overloaded
- Onion service may be slow/unreachable
- Network/Tor connection issues

In this case, contact sistemista (coordinator admin) for investigation.

---

## üìÅ Modified Files

1. `WalletWasabi/Helpers/Constants.cs` (lines 103-104)
   - Version bumped to 3.4.5
   - Name updated to "Swiss Tor Timeout Fix"

2. `WalletWasabi/WabiSabi/Client/RoundStateAwaiters/RoundStateUpdater.cs` (lines 7, 92-155)
   - Added `using WalletWasabi.Logging;`
   - Increased timeout from 30s ‚Üí 180s
   - Added timing measurements and diagnostic logging
   - Refactored into two methods for clarity

3. `WalletWasabi/WebClients/Wasabi/SwissCoordinatorHttpClientFactory.cs` (lines 53-60)
   - Added conditional timeout: 300s for onion, 120s for clearnet
   - Added debug logging for timeout values

---

## üöÄ Build Information

**Build Command**:
```bash
rm -rf packages/* build/* && ./Contrib/build-all.sh
```

**Platforms**:
- ‚úÖ macOS ARM64 (Apple Silicon)
- ‚úÖ macOS x64 (Intel)
- ‚úÖ Windows x64
- ‚úÖ Linux x64 + .deb

**Package Naming**:
- `SwissWallet-3.4.5-macOS-arm64.zip`
- `SwissWallet-3.4.5-macOS-x64.zip`
- `SwissWallet-3.4.5-win-x64.zip`
- `SwissWallet-3.4.5-linux-x64.zip`
- `SwissWallet-3.4.5-linux-x64.tar.gz`

---

## üìà Success Criteria

**v3.4.5 is successful if**:

1. ‚úÖ Logs clearly show timing information for coordinator requests
2. ‚úÖ Requests complete within 180s window (when coordinator is responsive)
3. ‚úÖ CoinJoin starts successfully when rounds are available
4. ‚úÖ Clear error messages when coordinator is not responding

**Next Steps if Still Failing**:

If logs show 180s timeouts, investigate:
1. Coordinator availability (ask sistemista)
2. Tor circuit quality (check Tor logs)
3. Network connectivity issues
4. Consider clearnet fallback testing

---

## üîó References

- **Debug Report**: User provided detailed debug report showing TaskCanceledException in RoundStateUpdater
- **Session State**: `/home/swisswallet/swisswallet/SESSION_STATE.md`
- **Diagnosis Doc**: `/home/swisswallet/swisswallet/COINJOIN_DIAGNOSIS_v3.4.3.md`
- **Previous Release**: v3.4.4 "Swiss Round Detection"

---

## ü§ñ Generated by Claude Code

This release was developed with assistance from Claude Code (claude.ai/code) to diagnose and fix CoinJoin connectivity issues.

**Development Session**: 2025-10-11
**Primary Goal**: Eliminate HTTP timeouts preventing CoinJoin from starting
